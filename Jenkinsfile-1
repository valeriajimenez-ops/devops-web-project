pipeline {
    agent {
        node {
            label 'built-in'
        }
    }
    tools {
        maven 'Maven 3.9.x'
    }
    environment {
        DOCKER_USERNAME = 'ginavaleriajimenez'
        DOCKER_TOKEN = 'dckr_pat_U4_5aoYEIoZrSkx7q04uLF9gVB4'
    }
    stages {
        stage('Packaging') {
            steps {
                echo 'Packaging Frontend...'
                bat 'mvn clean package'
            }
        }
        stage('Copying war file') {
            steps {
                echo 'Copying war file...'
                powershell 'Copy-Item -Path "target/*.war" -Destination "." -Force'
            }
        }
        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                bat 'docker build -t ginavaleriajimenez/devops-web-project:v1 --label devops-web-project-server .'
            }
        }
        stage('Docker Hub Login') {
            steps {
                echo '[INFO] Iniciando sesión en Docker Hub...'
                powershell """
                    echo ${DOCKER_TOKEN} | docker login -u "${DOCKER_USERNAME}" --password-stdin
                """
            }
        }
        stage('Push to Docker Hub') {
            steps {
                echo '[INFO] Publicando imagen en Docker Hub...'
                bat 'docker push ginavaleriajimenez/devops-web-project:v1'
            }
        }
    }
    post {
        always {
            echo '[INFO] Cerrando sesión de Docker...'
            bat 'docker logout || echo "Ya estaba desconectado."'
        }
        failure {
            echo '[ERROR] La ejecución del pipeline falló. Revisa los logs para más detalles.'
        }
    }
}
